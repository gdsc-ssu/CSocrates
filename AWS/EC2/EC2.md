### EC2란?

(Elastic Compute Cloud)

**아마존 웹 서비스(AWS)에서 제공하는 클라우드 컴퓨팅 서비스**

AWS에서 자주 사용되는 서비스이며 클라우드 공간에 크기가 유연하게 변경되는 가상 서버 기능을 제공
인스턴스라고도 불리우며 클라우드 공간에 가상 서버를 만들어 AWS에서 제공하는 다양한 애플리케이션을 돌릴 수 있음

> **EC2서비스는 AWS에서 비용, 성능, 용량면에서 탄력적인 클라우드 컴퓨터를 제공하는 서비스라고 할 수 있다**

### EC2를 사용해야 하는 이유
![[EC2 사용 이유.png]]
클릭 몇 번 만으로 서버를 생성할 수 있기 때문에 실제 서버를 구축하는 것 보다 간편하고 효율적
사용한 만큼 비용을 지불하면 되므로 비용 절감 가능

### EC2 인스턴스 생성 의미

![[EC2 인스턴스.png|500]]
AWS EC2 인스턴스를 생성한다는 것은 **AMI를 토대로 운영체제, CPU, RAM 혹은 런타임 등이 구성된 컴퓨터를 빌리는 것**

**AMI?**
(Amazon Machine Images)

EC2 인스턴스를 시작하는 데 필요한 정보가 들어있는 이미지 즉, **EC2의 복사본** 이라고 보면 됨
인스턴스는 AMI의 사본으로 한 AMI로 여러 인스턴스 실행도 가능

![[AMI.png|300]]

- 사용 할 수 있는 대표적인 OS
    - Amazon Linux2
    - CentOS
    - Red Hat Enterprise Linux
    - Windows Server
    - Ubuntu

> Amazon Machine Image(AMI) 선택이라는 것은 **운영체제를 선택**한다고 보면 된다

### EC2 인스턴스 유형

![[인스턴스 유형.png]]

게임에서 한정된 스탯으로 힘/민첩/지능 중에 어느걸 찍을지 결정하는 것처럼,

EC2 인스턴스란 한정된 요금으로 EC2 인스턴스의 유형(직업)을 고르고 사이즈(스탯 포인트)를 골라 각 인스턴스별로 사용 목적에 따라 최적화를 시키는 것을 말함

aws는 각 인스턴스의 **사용 목적(서버용, 머신러닝용, 게임용)에 따라 타입별로 인스턴스에 이름을 부여해 구분**함

범용 및 컴퓨팅, 메모리, 저장 최적화 성능 목적에 따라 타입이 여러가지 존재하는데 특히 t와 m은 범용 타입이기 때문에 aws 초보자들이 가장 많이 사용하는 프리티어에서 쓰는 타입

- **범용** : vCPU, 메모리, 네트워크, 저장 공간 등이 평균적인 사양으로 제공
- **컴퓨팅 최적화**: 다른 인스턴스 패밀리에 비해 메모리 대비 vCPU 비율이 높음
- **메모리 최적화** : 다른 인스턴스 패밀리에 비해 메모리 용량이 훨씬 큼
- **스토리지 최적화** : 다른 인스턴스 패밀리보다 스토리지 용량이 훨씬 크거나 초고속 I/O가 제공
- **GPU 인스턴스**: 고성능의 NVDIA GPU가 장착되어 있다. CUDA, OpenCL등을 실행할 때 사용됨
- **마이크로 인스턴스** : 가격이 가장 싼 인스턴스. 낮은 vCPU 성능과 적은 메모리가 제공된다. 프리티어에서는 이 인스턴스 유형을 무료로 사용할 수 있음


**!인스턴스 타입 읽는 법!**
![[인스턴스 타입 읽는 법.png|500]]

**m**은 인스턴스 타입 (패밀리) (범용 애플리케이션 서버용)을 의미하며, **5**는 5세대를 의미한다. **a**는 amd기반의 CPU 프로세서를 사용한다는 의미이며, **xlarge**는 큰 사이즈를 의미한다고 보면 됨

### 인스턴스 구매 옵션

![[인스턴스 구매 유형.png|600]]

EC2는 사용자의 요구사항에 따라 비용을 최적화 할 수 있도록 다음과 같은 구매 옵션을 제공

- **온디맨드 인스턴스( On Demand Instance )**
	- 필요할 때 바로 생성해서 사용할 수 있는 방식
	- 시간다 정해진 금액을 지불하면서 사용
	- (가장 짧은 시간은 60초!)
	- 소프트웨어 검증 및 개발단계에 사용하면 좋음

- **예약 인스턴스 ( Reserved Instacne )**
	- 일정한 예약금을 선불로 내면 인스턴스를 1년 또는 3년동안 예약할 수 있으며 시간당 요금이 대폭 할인됨
	- 개발 시작과 끝을 알고 있을 때 사용하면 좋음
	- 온디맨드와 달리 인스턴스의 크기를 늘리거나 줄일 수 없음

- **스팟 인스턴스( Spot Instance )**
	- 경매 방식의 인스턴스
	- 인스턴스의 스펙을 설정하고 원하는 가격을 입력하여 입찰하면 높게 입찰한 사람한테 인스턴스가 할당됨
	- 해당 스펙의 인스턴스를 다른 사람이 더 높은 가격으로 입찰했다면 내가 가지고 있는 인스턴스는 종료된다는 점

### EBS

(Elastic Block Store)
**EC2 인스턴스에 장착하여 사용할 수 있는 가상 저장 장치로 파일 및 오브젝트를 보관할 수 있는 스토리지 볼륨을 만들어줌**

컴퓨터를 사용하기 위해서 하드디스크가 필요한 것 처럼 EC2 인스턴스를 사용할 때도 스토리지가 요구됨
EBS가 여기서 EC2의 스토리지 역할을 함

- EBS는 EC2에 설치된 OS에서 그냥 일반적인 하드디스크나 SSD처럼 인식됨
	→ 원하는 크기로 만들 수 있고, 성능 또한 원하는 수치로 설정할 수 있음
	→ 사용자가 삭제하기 전까지는 데이터가 안전하게 유지된다

- 사용하는 경우 예시
    - EC2 인스턴스에서 제공하는 기본 용량보다 더 사용해야 할 때
    - 운영체제를 중단시키지 않고 용량을 자유롭게 늘리고 싶을 때
    - 영구적인 데이터 보관이 필요할 때
    - RAID 등의 고급 기능이 필요할 때

*한 가지 중요한 사실은 EC2 인스턴스가 종료되어도 EBS 안에 들어있는 데이터는 여전히 존재함. 그래서 인스턴스를 다시 켰을 경우에도 똑같은 데이터를 사용할 수 있음*

### EBS 가용영역

AWS를 사용할 때 리전으로 리소스가 분리되어 있고 그 리전 안에서 가용영역으로 범위를 또 나누게 됨

하나의 리전 안에는 여러개의 가용 영역이 존재할 수 있는데, 가용 영역은 메인 서버에서 만들어지는 일종의 복사본이라고 보면 됨

근데 왜 존을 나눠 따로 사용해야 하나?

가용영역을 사용하는 가장 중요한 이유는 재해 복구 때문
한족 서버가 셧다운 되거나 문제가 생기더라도 백업본으로 서버가 운영되는 것을 가능하게 함

~~계란을 한 바구니에 담지 말라!~~

![[가용영역.png|500]]

### EBS 기본 개념

- **볼륨 ( volume )** : EBS의 가장 기본적인 형태로 OS에서 바로 사용 가능한 형태
- **이미지 ( Image )** : AMI(Amazon Machine Image)를 줄여 부르는 말. OS가 설치된 형태이며 이 AMI로 EC2 인스턴스를 생성
- **스냅샷( Snapshot )** : EBS 볼륨의 전체 내용 중 특정 시점을 그대로 복사해 저장한 파일을 뜻함. 따라서 **EBS 볼륨의 백업 파일 성격**을 가지고 있음. EBS 스냅샷은 EBS 볼륨을 백업하고 이전 내용으로 복원하고 싶을 때, 나만의 AMI를 생성하고 싶을 때, EBS 볼륨을 다른 리전으로 이전하고 싶을 때 사용
- **IOPS(Input/Output Operation Per Second)** : 저장 장치의 성능 측정 단위. AWS에서는 추가 비용을 지불하고 높은 성능(IOPS)의 EBS를 생성할 수 있음

> EC2 인스턴스르 생성할 때 기본적으로 **OS가 설치된 EBS 볼륨을 함께 생성**하게 된다

### EBS 볼륨 타입

- SSD
	- 읽기/쓰기, 입출력의 비중이 매우 클 때 사용하면 좋음
	- **General Purpose SSD(gp2)**
	- **Provisioned IOPS SSD(io1)**
		![[스크린샷 2024-05-11 오후 5.36.33.png|400]]
- HDD
	- 방대한 스트리밍 워크로드를 신경 써야 할때 사용하면 좋음 
		- **Throughput Optimized HHd(st1)**
		- **CCD HDD(sc1)**
		- **Magnetic(standard)**
			![[스크린샷 2024-05-11 오후 5.40.17.png|400]]
			![[스크린샷 2024-05-11 오후 5.41.18.png|400]]

각각의 볼륨 타입은 다른 퍼포먼스 성능을 가지고 그에 따른 비용이 다르게 책정됨
따라서 원하는 시나리오에 맞게 EBS 볼륨 타입을 설정해 주는 것이 중요함

### ELB

서버를 다룰 때 네트워크 트래픽이 한쪽으로 몰려 서버 다운이나 예상치 못한 문제가 발생할 수 있음

![[스크린샷 2024-05-11 오후 6.53.31.png|500]]

여기서 ELB를 사용하여 서버 트랙픽을 원활하게 해줌

즉, ELB는 건강하지 않은 인스턴스를 건강하게 치료해주는 의사 역할이라고 생각할 수 있음

**어떻게 처리해 주냐?**

서버의 흐름을 어느 한쪽으로 치우치지 않고 인스턴스에 공평하게 배분하도록 함
이로서 들어오는 양에 비해 나가는 양이 급격히 감소되는 상황인 병목현상을 방지해줌

이는 서버의 원활한 작동 및 빠른 속도를 유지할 수 있게 해주는 원동력이 됨

### ELB 타입

**애플리케이션 로드 밸런서(ALB)**
네트워크 일곱 번째 OSI 레이어에서 작동
인스턴스에 서버 흐름을 디폴트로 배분하는 대신 개발자가 직접 개입하여 서버 흐름을 설정할 수 있도록 하는 라우팅 커스터마이징 기능을 제공

**네트워크 로드 밸런서(NLB)**
Transport Layer인 네 번째 레이어에서 작동
TCP 트래픽을 관리하기 때문에 수 많은 요청이 들어올 수 있으며, NLB는 극도의 퍼포먼스를 자랑하여 미세한 지연으로 엄청난 요펑들을 처리할 때 유용하게 사용
주로 개발 환경이 아닌 프로덕션 환경에서 방대한 데이터를 처리할 때 사용

**클래식 로드 밸런서(CLB)**
앞서 언급한 두 밸런서보다 성능이 뒤처지고 거의 사용하지 않는 레거시임

ALB에서 제공하는 레이어 7의 HTTP/HTTPS 라우팅 가능, NLB에서 제공하는 TCP 트래픽 요청 라우팅 기능 모두 CLB로 처리 가능
단점으로는 요청과 네트워크 연결에 근거하여 서버 트래픽을 제어할 수 있으나 네트워크 호스트가 누구인지 알 수 없음
따라서 안전한 연결을 해도 되는지 아닌지에 대한 판단 불가
![[스크린샷 2024-05-11 오후 7.13.19.png|200]]


### ELB 에러

ELB를 사용할 때 에러가 발생할 수 있는데...

그 중 가장 대표적인 에러는 애플리케이션이나 서버에서 특정 시간 내에 응답을 받지 못할 경우 생기는 **Load Balancer Error**임
![[Load Balancer Error.png|300]]

**ELB를 사용해서 네트워크의 흐름을 원활하게 함에도 불구하고 왜 타임아웃 에러가 발생할까?**

이 문제는 서버 레이어, 데아터베이스 레이어에서 발생하기 때문에 쉽게 해결 가능

로드 밸런서에는 최대 접속 시간 제한이라는 설정이 있는데, 디폴트는 60초로 지정되어 있으며 로드 밸런서가 60초동안 아무런 데이터도 전달받지 못할 경우 연결을 자동으로 종료하고 타임아웃 에러를 생성함

현재 돌아가는 애플리케이션의 규모가 크다면 최대 접속 시간 제한을 변경해 로드 밸런서가 기다려줄 수 있는 시간을 조금이라도 늘려보면 됨
그렇지 않다면 직접 애플리케이션을 수정해서 서버로 전송되는 데이터의 양을 조절하거나 서버에서의 응답 시간을 최적화시켜야함

### X-Forwarded-For 헤더

이 헤더는 HTTP/HTTPS 요청을 로드 밸런서에서 받을 때 출처에 대한 정보를 담고 있음

즉, X-Forwarded-For(XFF) 헤더는 HTTP 요청 헤더 중 하나로, 클라이언트의 IP 주소를 식별하는 데 사용됨
XFF 헤더는 HTTP 프록시나 로드 밸런서를 통해 웹 서버에 접속하는 클라이언트의 실제 IP 주소를 식별하는 사실상의 표준 헤더임

![[X-Forwarded-For 헤더의 사용 용도.png|600]]

> X-Forwarded-For: < client >, < proxy1 >, < proxy2 >

< client > : 클라이언트 IP 주소
< proxy1 >, < proxy2 > : 하나의 요청이 여러 프록시들을 거치면, 각 프록시의 IP 주소들이 차례로 열거됨. 즉, 가장 오른쪽 IP 주소는 가장 마지막에 거친 프록시의 IP 주소임

따라서 X-Forwarded-For 헤더는 콤마를 구분자로 Client와 Proxy IP 가 들어가게 되기 때문에 첫번째 IP 를 가져오면 실제 요청한 Client IP를 가져올 수 있게 됨

### 참고

https://velog.io/@server30sopt/AWS-EC2-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC

https://www.lesstif.com/software-architect/proxy-client-ip-x-forwarded-for-xff-http-header-20775886.html#Proxy(%ED%94%84%EB%9D%BD%EC%8B%9C)%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9CclientIP%EB%A5%BC%EC%96%BB%EA%B8%B0%EC%9C%84%ED%95%9CXForwardedFor(XFF)httpheader-WAS%EC%97%90%EC%84%9C%EC%82%AC%EC%9A%A9

https://it-study.tistory.com/37
