#networklayer
### 출처
* https://aws-hyoh.tistory.com/entry/ARP-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0 (ARP에 대해서)
* https://blog.naver.com/goduck2/220142854627 (라우터)
___
### 개요
* [[#라우터란]]
* [[#라우팅이란]]
* [[#라우팅 자세히]]
* [[#3개 테이블]]
* [[#라우팅 예시]]
* [[#라우팅 알고리즘]]
* [[#라우팅 프로토콜]]
* [[#홉 카운트 세는 법]]
___
### 라우터란
<b><u>라우터는 네트워크 간 데이터 패킷 전송을 진행하는 장치이다. 라우터는 IP를 통해 패킷의 도착지를 파악해 패킷이 가장 빠르고 안전하게 전달될 수 있는 경로를 설정한다.</u></b> 외부 네트워크으로 부터 패킷이 들어오거나 나가기 위해선 반드시 라우터를 지나가야하며 이러한 점에서 게이트 웨이로써의 기능도 수행한다.
![][https://img.danawa.com/prod_img/500000/188/346/img/14346188_1.jpg?shrink=330:*&_v=20211112171654]

* **라우터는 왜 쓸까?**
네트워크를 구축하는 작업은 L2 스위치 만으로도 충분하다. 우리는 일전에 LAN을 학습하면서 스위치만을 활용해 LAN을 구축했다. 그렇다면 스위치의 연속만으로 충분히 거대 네트워크를 구축할 수 있지 않을까?  

이는 불가한 것은 아니지만 이렇게 구축할 경우 심각한 문제가 야기된다. 외부 네트워크에 속한 호스트와 통신을 진행해야 한다고 해보자, 만약 라우터가 없다면 라우팅이 존재하지 않기에 연속된 브로드 캐스트를 통해서 해당 호스트와 연결된 스위치를 찾고 해당 호스트의 맥 주소를 파악해 커넥션을 수립한 이후 연결을 진행해 나가야 할 것이다. 이는 마치 주민번호만으로 사람을 찾는 것과 동일한 작업이 된다. 모든 곳을 뛰어다니며 주민번호를 외치는 방식말고 찾을 수 있는 방법이 없다. 

라우터를 사용하면 NAT의 사용이 가능해지면서 특정 ip를 기준으로 호스트들을 묶을 수 있게 된다. 주민번호가 아닌 서울시 동작구와 같이 여러 호스트가 속하는 더욱 큰 범위로 식별이 가능해진다는 것이다. 또한 해당 범위에 속한 호스트들로 네트워크의 범위가 한정되며 브로드캐스트로 인한 오버헤드도 줄어들게 된다.

따라서 스위치에 라우팅 알고리즘을 추가하지 않고 ==**라우터라는 별개의 장치를 운영하는 이유는 라우팅 이외에 네트워크 분리 작업을 수행하기 때문이다. 뿐만 아니라 외부 네트워크를 타고 들어오는 패킷의 위험성 검증을 위한 방화벽과 같은 기능이나 로드 밸런싱도 라우터에서 제공한다.**==

> [!info]
> **스위치만으로 네트워크를 구축하면 브로드캐스트 재앙이 발생한다.**

___
### 라우팅이란
라우팅은 라우팅 프로토콜을 통해 생성된 라우팅 테이블을 기반으로 데이터가 전송될 경로를 미리 정해 놓는 행위를 말한다. 이를 통해 데이터는 최적의 경로를 빠르게 파악할 수 있고 네트워크의 효율성을 올리는 것이 가능해진다.
<b><u>라우팅을 위해선 해당 목적지로 통하는 지도가 필요한데, 이때 사용하는 것이 라우팅 테이블이다. </u></b>테이블에는 각 라우터의  목적지의 ip주소와 해당 목적지로 가기 위한 다음 라우터의 ip가 저장돼 있다. 라우팅 테이블은 netstat  명령어로 확인할 수 있으며, 지정할 경우 특정 IP로의 통신을 전담하는 라우터를 지정하거나 하는 작업을 수행할 수 있다.  
![[스크린샷 2023-11-10 오후 2.03.41.png]]
라우팅 테이블은 초기에는 기초적인 내용만 존재하고 이후 네트워크 통신을 진행하며 채워나가는데 라우팅 테이블을 채워나가는 과정은 ARP를 활용해 MAC 테이블을 채우는 스위치와 흡사하다. 
___
### 라우팅 자세히
라우팅의 핵심은 다른 네트워크와 통신이 필요한 경우에만 사용한다는 것이다. 동일 네트워크에 속할 경우 브로드 캐스트를 통해 전달이 가능하다. 하지만 앞서 살펴봤듯이 네트워크의 구분 없이 단일한 거대 네트워크를 설계할 경우 브로드캐스트 작업이 감당이 안될만큼 큰 오버 헤드를 갖게 된다. 따라서 **==브로드캐스트가 영향을 미치는 범위를 제한해 네트워크를 구분 하기로 했고 이러한 네트워크의 구분 점으로 라우터가 게이트 웨이로써의 기능 또한 수행한다고 정리했다.==** 즉, 라우팅은 브로드 캐스트가 닿지 않는 범위에 속한 호스트와 통신을 진행하기 위해 개발된 기술이다.

두 호스트가 서로 통신을 진행한다고 했을 때 서로 같은 네트워크에 속한다면 ARP를 통해 곧장 MAC 주소를 받고 통신을 진행할 수 있다. 하지만 다른 네트워크에 속한다면 해당 호스트에 ARP 리퀘스트를 보낼 수 있는 8번 라우터에 우선적으로 ARP 리퀘스트를 전달 해야만한다. 하지만 8번 라우터와도 LAN으로 연결이 돼있지 않기에 8번 라우터까지 도달할 수 있는 7번 라우터로 우선적으로 ARP를 전달해야 한다. 이렇게 계속해서 탐색을 해나가며 LAN 연결의 연속으로 다른 LAN의 호스트과의 연결을 성립하는 과정이 라우팅이다.
![][https://postfiles.pstatic.net/20141007_7/goduck2_1412614139941GrpzI_PNG/router_4_hop.png?type=w1]

* **왜 ARP 리퀘스트를 보내요?**
LAN을 연속적으로 탐색하면서 상대 호스트 ip가 위치한 곳까지 경로를 찾는다는 것은 이해했다. 그런데 왜 ARP 리퀘스트를 보낼까?  이는 우리가 서버1의 MAC 주소를 파악하지 못하고 있기 때문이다. 통신을 위해선 ip주소 뿐만 아니라 MAC 주소도 필요하다. 이에 따라 ARP 리퀘스트를 통해 서버1의 MAC 주소를 얻기 위해 ARP 리퀘스트를 전송한다.

* **왜 IP가 있는데 MAC을 또 쓰나요?**
**IP는 형식적인 주소로 사용되는 경우가 많기 때문이다.** 아래의 이미지를 보자.
![][https://blog.kakaocdn.net/dn/l4mjn/btqE9dmDWRb/C9oLJr9vZCq6pVarf74UHK/img.png]
각 호스트별로 IP가 구분돼 IP 만으로 통신이 가능할 것 같지만, IP는 얼마든지 변할 수 있는 값이다. 동적할당의 경우만 살펴봐도 IP가 얼마든지 수정될 수 있다는 것을 확인할 수 있다. 이에 따라 불변하지 않는 주소로 MAC 주소를 활용한다. IP가 변해도 MAC주소는 변하지 않기 때문에 늘 정확한 위치를 특정할 수 있다. 

직관적 예시로 물리주소와 논리주소를 들 수 있다. 동작구 상도로 20-1은 행정 주소로 법안이 변경되면 바뀔 수 있지만, 숭실대 정보대 옆 건물이라는 물리주소는 변하지 않는다.

___
### 3개 테이블
* **MAC 테이블**
	맥 테이블은 스위치에서 활용하는 테이블로 스위치가 사용하는 포트와 MAC 주소가 대응돼 있는 테이블을 말한다. 이를 통해 스위치는 특정 MAC 주소로의 요청을 몇번 포트로 스위칭 해줄지 결정한다.

* **ARP 테이블**
	ARP 테이블은 IP 주소와  MAC 주소를 대응한 테이블로 IP를 통해 MAC 주소를 획득하고자 할때 사용한다.

* **라우팅 테이블**
	라우팅 테이블은 라우팅에 활용되는 테이블로 목적지로 가기 위한 다음 라우터의 IP를 저장한다.

네트워크 통신을 위해선 3개의 테이블을 모두 사용할 필요가 있으며 3개 테이블중 어느곳에 문제가 있을 경우 패킷이 손실된 가능성이 굉장히 높다.
___
### 라우팅 예시
이제 본격적으로 라우팅의 예시를 살펴보자. 아래와 같이 네트워크가 구축돼 있는 상황이다.
![][https://postfiles.pstatic.net/20141016_35/goduck2_1413390981840VqXcg_PNG/Multi_LANs_IP_allocation.png?type=w1]
초기에 라우터의 라우팅 테이블과 스위치의 맥 테이블 그리고 PC에 있는 ARP 테이블을 살펴보면 아무 데이터가 없는 것을 확인할 수 있다.
![][https://postfiles.pstatic.net/20141016_69/goduck2_1413389296160AhaW6_PNG/Switch_Nothings.png?type=w1]
라우팅 테이블을 설정해 핑을 보내면 ARP와 MAC 테이블은 자동적으로 업데이트가 되므로 우선적으로 라우팅 테이블을 설정해준다. 가장 앞에 위치한 라우터0를 설정하면 아래와 같다.
![][https://postfiles.pstatic.net/20141016_22/goduck2_1413391421035KsUAe_PNG/Router0_Routing_Table.png?type=w1]
직접적으로 연결된 장치들은 전부 directly connected로 표시돼 있다. 유심히 봐야할 부분은 0.0.0.0의 목적지 인데 해당 엔트리는 디폴트 라우터로 존재하지 않는 목적지를 갖는 IP가 올 경우 전부 192.168.30.2(다음 라우터)로 전송한다. ==**만약 디폴트 라우터를 설정해주지 않을 경우 엔트리에 해당하지 않는 패킷은 전부 버린다.**==
![][https://postfiles.pstatic.net/20141016_140/goduck2_1413396486943BHiwX_PNG/PC0_ping.png?type=w1]
라우팅 테이블을 위와 같이 전부 설정해주면 이후 ping을 쐈을 때 pc0에서 목적지인 서버0까지 도달하는 것을 확인할 수 있다. ARP나 MAC 테이블을 따로 설정하지 않았음에도 핑이 전송되는 이유는 자동적으로 ARP와 MAC테이블이 업데이트 되기 떄문이다.
___
### 라우팅 알고리즘
* **Link-State Routing Algorithm**
	각 라우터는 자신의 인접 링크에 브로드 캐스팅을 실시해 네트워크 전체에 대한 정보를 파악한다. 각 라우터는 자신의 정보를 다른 라우터와 공유해 네트워크 전체 노드에 대한 데이터를 활용해 다익스트라와 같은 최단거리 알고리즘을 수행한다.

* **Distance vector algorithm**
	자신의 근처에 인접한 라우터의 데이터만을 활용해서 진행한다. 주로 거리에 기반해 벨만 포드를 활용한다.
____
### 라우팅 프로토콜
* **정적 라우팅**
	네트워크 관리자가 수동으로  라우팅 테이블을 관리하는 것을 의미한다. 경로를 사람이 결정하며 라우터는 입력된 경로로만 패킷을 전달한다. <u><b>이러한 방식은 라우팅을 위한 라우터간 패킷 교환을 줄여 속도가 빠르고 외부에 경로를 알릴 필요도 없기 때문에 보안성이 높다. 하지만 네트워크 상황이 변경됐을 때 대응이 어렵다.</b></u>

* **동적 라우팅**
	실제 네트워크 조건에 따라 라우팅 테이블을 실시간으로 업데이트 한다. 네트워크의 현황을 반영해 유연하게 대응이 가능하다. 하지만 그때 그때 경로를 지정해야 하기에 라우터 패킷 교환을 위한 오버헤드가 크고 보안성이 떨어진다.

* **RIP(Routing Information Protocol)**
	RIP는 최소 홉 카운트를 파악해 라우팅하는 프로토콜이다.  다이나믹 라우팅 프로토콜이며, 건너야할 홉 카운트가 가장 적은 경로를 택하여 라우팅하는 프로토콜이다. 홉 카운트만을 기준으로 진행하기 때문에 네트워크의 속도 등은 고려하지 않는다.

* **OSPF(Open Shortest Path First)**
	최단 경로를 우선적으로 채택하는 알고리즘으로 시간을 기준으로 경로를 결정한다. 주로 기업 내부망에서 활용한다. 네트워크 상태에 변화가 있을 경우 즉각적으로 Flooding 해주기 때문에 대응이 빠르다.
___
### 홉 카운트 세는 법
홉 카운트는 연결의 시작점과 끝점 사이에 존재하는 LAN의 수를 의미한다. 아래의 이미지를 보자.
![][https://postfiles.pstatic.net/20141007_7/goduck2_1412614139941GrpzI_PNG/router_4_hop.png?type=w1]

위 이미지의 홉의 개수는 총 5개이다. 라우터간에 3개의 LAN이 존재하고 호스트와 라우터를 연결하기 위한 LAN이 2개씩 존재하므로 총 5개가 된다.
![][https://postfiles.pstatic.net/20141007_116/goduck2_1412615287208F09fk_PNG/switch_5_segment.png?type=w1]
이 경우의 홉의 수는 1개가 되는데, 이는 스위치를 아무리 연결해도 결국 같은 LAN이기 때문이다.