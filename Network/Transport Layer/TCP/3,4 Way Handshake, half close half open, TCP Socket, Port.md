# 3 Way Handshake

TCP는 안정적이고 연결지향적인 4계층용 프로토콜이다.
연결 세션 설정을 하기 위해 3 way handshake를 한다.

![](http://www.ktword.co.kr/img_data/1901_1.JPG)

TCP 패킷의 SYN 플래그, ACK 플래그를 설정하면 어떤 세그먼트인지 식별할 수 있다.

첫 번째 세그먼트인 SYN 세그먼트에서는 클라이언트가 서버에게 연결 요청을 한다.
데이터는 전송하지 않지만 하나의 순서번호를 소비한다. (순서 번호 = 클라이언트 측 ISN)
여기서 순서번호란? TCP연결 설정을 위해 TCP 세그먼트의 첫 번째 바이트에 부여되는 번호로, 난수 발생기를 통해 발생시키고 순서 번호 필드에 넣어서 보낸다. 양방향 설정이 기본이므로 각 방향마다 서로 다른 ISN(Initial Sequence Number) 번호가 사용된다.
확인응답 번호나 윈도우 크기 필드는 정의되지 않는다.

서버에서는 연결 요청을 받으면 연결 허락을 보낸다. 이게 두 번째 세그먼트인 SYN+ACK 세그먼트.
데이터는 전송하지 않지만 하나의 순서 번호를 소비한다. (순서 번호 = 서버 측 ISN)
확인 응답 번호는 수신된 순서번호 + 1 값을 가진다. (다음 ACK 세그먼트에서 이 값을 순서번호로 받아야 한다.)
서버는 LISTEN 상태에서 SYN-RECEIVED 상태로 전이되며, 이를 Half Open이라고 함.

클라이언트에서 서버의 연결 허락을 받으면 연결 설정을 해야 한다. 이게 마지막 세그먼트인 ACK 세그먼트.
수신된 순서번호 + 1을 승인 번호로 보내고, 순서 번호 (확인 응답 번호)를 두번째 세그먼트에서 받은 확인 응답 번호를 복사해서 보낸다.
데이터는 전송하지 않고, 순서 번호도 소비하지 않는다.

# 4 Way Handshake
![](http://www.ktword.co.kr/img_data/2436_1.JPG)

4 way handshake는 정상적인 연결 종료 방법이다.
클라이언트가 FIN 세그먼트를 어플리케이션 종료하면서 날린다.
ACK 세그먼트로 연결 종료 요청에 대해 서버의 응답을 클라이언트로 보낸다.
서버측 Application의 종료를 기다린 다음 서버가 FIN+ACK 세그먼트로 종료 알림을 보내면, 
클라이언트 측이 ACK 를 보내고 끝낸다. 이 때 클라이언트는 최대 세그먼트 수명의 2배를 기다린 다음 closed된다.

# Half Close, Half Open

# TCP Socket, Port